#!/bin/bash

#Check dates of Critical and High CVEs

cat cves/output.json | jq -r '.matches | .[] | select(.vulnerability.severity == "Critical") | if .vulnerability.id | test("CVE") then .vulnerability.id else .relatedVulnerabilities[].id end' > critical_cves.txt
cat cves/output.json | jq -r '.matches | .[] | select(.vulnerability.severity == "High") | if .vulnerability.id | test("CVE") then .vulnerability.id else .relatedVulnerabilities[].id end' > high_cves.txt

#check list of Critical CVEs
set +x

current_critical_cves=()
current_high_cves=()

echo "Past Due CVEs\n"
echo "Critical:\n"

while read cve; do
    modified_date=$(curl -s https://services.nvd.nist.gov/rest/json/cve/1.0/$cve | jq -r .result.CVE_Items[].lastModifiedDate)
    cve_date=$(date -d $modified_date  +"%Y%m%d")
    cutoff_date=$(date +"%Y%m%d" -d "-15 days")
    if [ $cve_date -lt $cutoff_date ]
    then echo "$cve"
    else
    current_critical_cves+=("$cve")
    fi
    sleep 7
done < critical_cves.txt

echo "\nHigh:\n"
#check list of High CVEs
while read cve; do
    modified_date=$(curl -s https://services.nvd.nist.gov/rest/json/cve/1.0/$cve | jq -r .result.CVE_Items[].lastModifiedDate)
    cve_date=$(date -d $modified_date  +"%Y%m%d")
    cutoff_date=$(date +"%Y%m%d" -d "-30 days")
    if [ $cve_date -lt $cutoff_date ]
    then echo "$cve"
    else
    current_high_cves+=("$cve")
    fi
    sleep 7
done < high_cves.txt

echo "\nCurrent Issues\n"
echo "Critical:\n"
for crit_issue in ${current_critical_cves[@]}; do
    echo $crit_issue
done

echo "\nHigh:\n"
for high_issue in ${current_high_cves[@]}; do
    echo $high_issue
done