#!/bin/bash

#Check dates of Critical and High CVEs

crit_date=$(date -d "-15 days" +"%Y%m%d")

cat cves/output.json | jq -r '.matches | .[] | select(.vulnerability.severity == "Critical") | if .vulnerability.id | test("CVE") then .vulnerability.id else .relatedVulnerabilities[].id end' > critical_cves.txt
cat cves/output.json | jq -r '.matches | .[] | select(.vulnerability.severity == "High") | if .vulnerability.id | test("CVE") then .vulnerability.id else .relatedVulnerabilities[].id end' > high_cves.txt

#check list of Critical CVEs

while read cve; do
    modified_date=$(curl https://services.nvd.nist.gov/rest/json/cve/1.0/$cve | jq -r .result.CVE_Items[].lastModifiedDate)
    cve_date=$(date -d $modified_date  +"%Y%m%d")
    cutoff_date=$(date +"%Y%m%d" -d "-15 days")
    if $cve_date -lt $cutoff_date
    then echo "$cve is older than 15 days"
    fi
    sleep 6
done < critical_cves.txt

#check list of High CVEs
while read cve; do
    modified_date=$(curl https://services.nvd.nist.gov/rest/json/cve/1.0/$cve | jq -r .result.CVE_Items[].lastModifiedDate)
    cve_date=$(date -d $modified_date  +"%Y%m%d")
    cutoff_date=$(date +"%Y%m%d" -d "-60 days")
    if $cve_date -lt $cutoff_date
    then echo "$cve is older than 15 days"
    fi
    sleep 6
done < high_cves.txt